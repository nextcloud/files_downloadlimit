{"version":3,"file":"files_downloadlimit-admin.mjs","sources":["../src/services/AdminService.ts","../src/views/AdminSettings.vue","../src/admin.ts"],"sourcesContent":["/**\n * SPDX-FileCopyrightText: 2024 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: AGPL-3.0-or-later\n */\n\nimport axios from '@nextcloud/axios'\nimport { showError } from '@nextcloud/dialogs'\nimport { t } from '@nextcloud/l10n'\nimport { generateOcsUrl } from '@nextcloud/router'\nimport { logger } from '../logger.ts'\n\n/**\n * Set the default download limit for all shares.\n *\n * @param limit - The new default limit\n */\nexport async function setDefaultLimit(limit: number): Promise<boolean> {\n\ttry {\n\t\tawait axios.put(generateOcsUrl('/apps/files_downloadlimit/api/v1/limit'), {\n\t\t\tlimit,\n\t\t})\n\t\treturn true\n\t} catch (error) {\n\t\tlogger.error('Failed to set default download limit', { error })\n\t\tshowError(t('files_downloadlimit', 'Failed to set default download limit'))\n\t}\n\treturn false\n}\n\n/**\n * Unset the configured default limit\n */\nexport async function removeDefaultLimit(): Promise<boolean> {\n\ttry {\n\t\tawait axios.delete(generateOcsUrl('/apps/files_downloadlimit/api/v1/limit'))\n\t\treturn true\n\t} catch (error) {\n\t\tlogger.error('Failed to remove default download limit', { error })\n\t\tshowError(t('files_downloadlimit', 'Failed to remove default download limit'))\n\t}\n\treturn false\n}\n","<!--\n  - SPDX-FileCopyrightText: 2024 Nextcloud GmbH and Nextcloud contributors\n  - SPDX-License-Identifier: AGPL-3.0-or-later\n-->\n\n<template>\n\t<NcSettingsSection\n\t\t:name=\"t('files_downloadlimit', 'Download limit')\"\n\t\t:description=\"t('files_downloadlimit', 'Configure the default download limit for external shares.')\">\n\t\t<NcCheckboxRadioSwitch\n\t\t\tv-model=\"enableDefaultLimit\"\n\t\t\t:loading=\"showLoading\"\n\t\t\ttype=\"switch\">\n\t\t\t{{ t('files_downloadlimit', 'Default download limit for external shares') }}\n\t\t</NcCheckboxRadioSwitch>\n\n\t\t<NcTextField\n\t\t\tv-show=\"enableDefaultLimit\"\n\t\t\tv-model=\"limit\"\n\t\t\tclass=\"settings__field\"\n\t\t\t:disabled=\"!enableDefaultLimit || showLoading\"\n\t\t\t:label=\"t('files_downloadlimit', 'Set default download limit')\"\n\t\t\ttype=\"number\"\n\t\t\tmin=\"1\"\n\t\t\t:helper-text=\"helperText\"\n\t\t\t:error=\"Boolean(helperText)\"\n\t\t\t:success=\"showSuccess\" />\n\t\t<div v-show=\"!enableDefaultLimit\" class=\"settings__placeholder\" />\n\t</NcSettingsSection>\n</template>\n\n<script lang=\"ts\">\nimport { loadState } from '@nextcloud/initial-state'\nimport { translate as t } from '@nextcloud/l10n'\nimport { defineComponent } from 'vue'\nimport NcCheckboxRadioSwitch from '@nextcloud/vue/components/NcCheckboxRadioSwitch'\nimport NcSettingsSection from '@nextcloud/vue/components/NcSettingsSection'\nimport NcTextField from '@nextcloud/vue/components/NcTextField'\nimport { removeDefaultLimit, setDefaultLimit } from '../services/AdminService.ts'\n\nconst defaultDownloadLimit = loadState<number>('files_downloadlimit', 'default-download-limit', -1)\n\nexport default defineComponent({\n\tname: 'AdminSettings',\n\n\tcomponents: {\n\t\tNcCheckboxRadioSwitch,\n\t\tNcSettingsSection,\n\t\tNcTextField,\n\t},\n\n\tdata() {\n\t\treturn {\n\t\t\tlimit: Math.max(defaultDownloadLimit, 10),\n\t\t\tenableDefaultLimit: defaultDownloadLimit !== -1,\n\t\t\tshowLoading: false,\n\t\t\tshowSuccess: false,\n\t\t}\n\t},\n\n\tcomputed: {\n\t\thelperText() {\n\t\t\tif (typeof this.limit === 'number' && this.limit <= 0) {\n\t\t\t\treturn t('files_downloadlimit', 'The minimum limit is 1')\n\t\t\t}\n\t\t\treturn ''\n\t\t},\n\t},\n\n\twatch: {\n\t\tasync limit(limit: number) {\n\t\t\tif (await setDefaultLimit(limit)) {\n\t\t\t\tthis.showSuccess = true\n\t\t\t\twindow.setTimeout(() => {\n\t\t\t\t\tthis.showSuccess = false\n\t\t\t\t}, 1000)\n\t\t\t}\n\t\t},\n\n\t\tasync enableDefaultLimit(enabled: boolean, oldValue: boolean) {\n\t\t\tthis.showLoading = true\n\t\t\tlet success: boolean\n\t\t\tif (enabled) {\n\t\t\t\tsuccess = await setDefaultLimit(10)\n\t\t\t} else {\n\t\t\t\tsuccess = await removeDefaultLimit()\n\t\t\t}\n\n\t\t\tif (!success) {\n\t\t\t\tthis.enableDefaultLimit = oldValue\n\t\t\t}\n\t\t\tthis.showLoading = false\n\t\t},\n\t},\n\n\tmethods: {\n\t\tt,\n\t},\n})\n</script>\n\n<style lang=\"scss\" scoped>\n.settings {\n\t&__field {\n\t\tmax-width: 500px;\n\t\tmargin-top: calc(3 * var(--default-grid-baseline)) !important;\n\t}\n\n\t&__placeholder {\n\t\t// ensure content does not jump when enable / disable the input\n\t\theight: calc(var(--default-clickable-area) + 3 * var(--default-grid-baseline));\n\t}\n}\n</style>\n","/**\n * SPDX-FileCopyrightText: 2024 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: AGPL-3.0-or-later\n */\n\nimport { createApp } from 'vue'\nimport AdminSettings from './views/AdminSettings.vue'\n\ncreateApp(AdminSettings)\n\t.mount('#admin-download-limit')\n"],"names":["setDefaultLimit","limit","axios","generateOcsUrl","error","logger","showError","t","removeDefaultLimit","defaultDownloadLimit","loadState","_sfc_main","defineComponent","NcCheckboxRadioSwitch","NcSettingsSection","NcTextField","enabled","oldValue","success","_hoisted_1","_createBlock","_component_NcSettingsSection","_ctx","_createVNode","_component_NcCheckboxRadioSwitch","_cache","$event","_createTextVNode","_toDisplayString","_component_NcTextField","_withDirectives","_createElementVNode","_vShow","createApp","AdminSettings"],"mappings":"oPAgBA,eAAsBA,EAAgBC,EAAiC,CACtE,GAAI,CACH,OAAA,MAAMC,EAAM,IAAIC,EAAe,wCAAwC,EAAG,CACzE,MAAAF,CAAA,CACA,EACM,EACR,OAASG,EAAO,CACfC,EAAO,MAAM,uCAAwC,CAAE,MAAAD,CAAA,CAAO,EAC9DE,EAAUC,EAAE,sBAAuB,sCAAsC,CAAC,CAC3E,CACA,MAAO,EACR,CAKA,eAAsBC,GAAuC,CAC5D,GAAI,CACH,OAAA,MAAMN,EAAM,OAAOC,EAAe,wCAAwC,CAAC,EACpE,EACR,OAASC,EAAO,CACfC,EAAO,MAAM,0CAA2C,CAAE,MAAAD,CAAA,CAAO,EACjEE,EAAUC,EAAE,sBAAuB,yCAAyC,CAAC,CAC9E,CACA,MAAO,EACR,CCDA,MAAME,EAAuBC,EAAkB,sBAAuB,yBAA0B,EAAE,EAElGC,EAAeC,EAAgB,CAC9B,KAAM,gBAEN,WAAY,CACX,sBAAAC,EACA,kBAAAC,EAAA,YACAC,CAAA,EAGD,MAAO,CACN,MAAO,CACN,MAAO,KAAK,IAAIN,EAAsB,EAAE,EACxC,mBAAoBA,IAAyB,GAC7C,YAAa,GACb,YAAa,EAAA,CAEf,EAEA,SAAU,CACT,YAAa,CACZ,OAAI,OAAO,KAAK,OAAU,UAAY,KAAK,OAAS,EAC5CF,EAAE,sBAAuB,wBAAwB,EAElD,EACR,CAAA,EAGD,MAAO,CACN,MAAM,MAAMN,EAAe,CACtB,MAAMD,EAAgBC,CAAK,IAC9B,KAAK,YAAc,GACnB,OAAO,WAAW,IAAM,CACvB,KAAK,YAAc,EACpB,EAAG,GAAI,EAET,EAEA,MAAM,mBAAmBe,EAAkBC,EAAmB,CAC7D,KAAK,YAAc,GACnB,IAAIC,EACAF,EACHE,EAAU,MAAMlB,EAAgB,EAAE,EAElCkB,EAAU,MAAMV,EAAA,EAGZU,IACJ,KAAK,mBAAqBD,GAE3B,KAAK,YAAc,EACpB,CAAA,EAGD,QAAS,CAAA,EACRV,CAAA,CAEF,CAAC,EAvEmCY,EAAA,CAAA,MAAM,uBAAA,oHArBzCC,EAsBoBC,EAAA,CArBlB,KAAMC,EAAA,EAAC,sBAAA,gBAAA,EACP,YAAaA,EAAA,EAAC,sBAAA,2DAAA,CAAA,EAAA,WACf,IAKwB,CALxBC,EAKwBC,EAAA,CAAA,WAJdF,EAAA,mBAAA,sBAAAG,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAJ,EAAA,mBAAkBI,GAC1B,QAASJ,EAAA,YACV,KAAK,QAAA,EAAA,WACL,IAA4E,CAAAK,EAAAC,EAAzEN,EAAA,EAAC,sBAAA,4CAAA,CAAA,EAAA,CAAA,CAAA,CAAA,qCAGLC,EAU0BM,EAAA,CAAA,WARhBP,EAAA,MAAA,sBAAAG,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAC,GAAAJ,EAAA,MAAKI,GACd,MAAM,kBACL,SAAQ,CAAGJ,EAAA,oBAAsBA,EAAA,YACjC,MAAOA,EAAA,EAAC,sBAAA,4BAAA,EACT,KAAK,SACL,IAAI,IACH,cAAaA,EAAA,WACb,MAAO,CAAA,CAAQA,EAAA,WACf,QAASA,EAAA,WAAA,EAAA,KAAA,EAAA,CAAA,aAAA,WAAA,QAAA,cAAA,QAAA,SAAA,CAAA,EAAA,IATFA,EAAA,kBAAkB,CAAA,CAAA,EAU3BQ,EAAAC,EAAkE,MAAlEZ,EAAkE,KAAA,GAAA,EAAA,CAAA,CAAAa,EAAA,CAApDV,EAAA,kBAAkB,CAAA,CAAA,+FCnBlCW,EAAUC,CAAa,EACrB,MAAM,uBAAuB"}